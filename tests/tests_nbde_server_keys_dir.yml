---
# When using either nbde_server_fetch_keys or nbde_server_deploy_keys,
# nbde_server_keys_dir needs to be set using an absolute path.

- name: Test nbde_server_keys_dir is properly set
  hosts: all

  tasks:
    - name: Test 1 - only nbde_server_fetch_keys set
      block:
        - name: With nbde_server_fetch_keys
          import_role:
            name: linux-system-roles.nbde_server
          vars:
            nbde_server_fetch_keys: yes

        - name: This task should not run
          debug:
            msg: Previous task should have failed
          register: nbde_server_failed
      rescue:
        - debug:
            msg: Test succeeded. Role failed with nbde_server_keys_dir not set
          register: nbde_server_success
      always:
        - fail:
            msg: Task should have failed with nbde_server_keys_dir not set
          when:
            - nbde_server_success is not defined
            - nbde_server_failed is defined


    - name: Test 2 - only nbde_server_deploy_keys set
      block:
        - name: With nbde_server_deploy_keys
          import_role:
            name: linux-system-roles.nbde_server
          vars:
            nbde_server_deploy_keys: yes

        - name: This task should not run
          debug:
            msg: Previous task should have failed
          register: nbde_server_failed
      rescue:
        - debug:
            msg: Test succeeded. Role failed with nbde_server_keys_dir not set
          register: nbde_server_success
      always:
        - fail:
            msg: Task should have failed with nbde_server_keys_dir not set
          when:
            - nbde_server_success is not defined
            - nbde_server_failed is defined


    - name: Test 3 - nbde_server_fetch_keys and nbde_server_deploy_keys set
      block:
        - name: With nbde_server_fetch_keys and deploy keys
          import_role:
            name: linux-system-roles.nbde_server
          vars:
            nbde_server_fetch_keys: yes
            nbde_server_deploy_keys: yes

        - name: This task should not run
          debug:
            msg: Previous task should have failed
          register: nbde_server_failed
      rescue:
        - debug:
            msg: Test succeeded. Role failed with nbde_server_keys_dir not set
          register: nbde_server_success
      always:
        - fail:
            msg: Task should have failed with nbde_server_keys_dir not set
          when:
            - nbde_server_success is not defined
            - nbde_server_failed is defined


    - name: Test 4 - nbde_server_keys_dir is absolute path
      block:
        - name: Directory starting with ./
          import_role:
            name: linux-system-roles.nbde_server
          vars:
            nbde_server_fetch_keys: yes
            nbde_server_keys_dir: ./foobar

        - name: This task should not run
          debug:
            msg: Previous task should have failed
          register: nbde_server_failed
      rescue:
        - debug:
            msg: >
              Test succeeded. Role failed with nbde_server_keys_dir
              not absolute path
          register: nbde_server_success
      always:
        - fail:
            msg: Task should have failed with nbde_server_keys_dir not set
          when:
            - nbde_server_success is not defined
            - nbde_server_failed is defined


    - name: Test 5 - nbde_server_keys_dir is absolute path
      block:
        - name: Directory without leading ./
          import_role:
            name: linux-system-roles.nbde_server
          vars:
            nbde_server_fetch_keys: yes
            nbde_server_keys_dir: foobar

        - name: This task should not run
          debug:
            msg: Previous task should have failed
          register: nbde_server_failed
      rescue:
        - debug:
            msg: >
              Test succeeded. Role failed with nbde_server_keys_dir
              not absolute path
          register: nbde_server_success
      always:
        - fail:
            msg: Task should have failed with nbde_server_keys_dir not set
          when:
            - nbde_server_success is not defined
            - nbde_server_failed is defined

# vim:set ts=2 sw=2 et:
