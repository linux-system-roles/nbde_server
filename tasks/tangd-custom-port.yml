---
- name: Allow the custom port for tangd_port_t in SELinux
  import_role:
    name: linux-system-roles.selinux
  vars:
    selinux_ports:
      - ports: "{{ nbde_server_port }}"
        proto: tcp
        setype: tangd_port_t
        state: present

- name: Create override file for custom port
  block:
    - name: Check if directory /etc/systemd/system/tangd.socket.d exist
      stat:
        path: /etc/systemd/system/tangd.socket.d
      register: systemd_system_tangd_socket

    - name: Create a directory if it does not exist
      file:
        path: /etc/systemd/system/tangd.socket.d
        state: directory
        mode: '0755'
      when: systemd_system_tangd_socket.stat.exists

    - name: Creates the file with the port entry that we want tangd to listen to
      template:
        src: tangd_socket_override.conf.j2
        dest: /etc/systemd/system/tangd.socket.d/override.conf
        backup: true
        mode: '0644'
      register: __nbde_server_daemon_reload

    - name: Reload the daemons so the new changes take effect
      systemd:
        daemon_reload: true
      when: __nbde_server_daemon_reload is changed

- name: Ensure the desired port is added to firewalld
  import_role:
    name: linux-system-roles.firewall
  vars:
    firewall: 
      - port: "{{ nbde_server_port }}/tcp"
        zone: "{{ nbde_server_firewall_zone }}"
        state: enabled
        immediate: true
        permanent: true
