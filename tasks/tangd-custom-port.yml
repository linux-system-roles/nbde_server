---
- name: Allow the custom port for tangd_port_t in SELinux
  import_role:
    name: fedora.linux-system-roles.selinux
  vars:
    selinux_ports:
      - ports: "{{ nbde_server_port }}"
        proto: tcp
        setype: tangd_port_t
        state: present

- name: Create override file for systemd for the custom tangd port
  block:
    - name: Check if directory /etc/systemd/system/tangd.socket.d exist
      stat:
        path: /etc/systemd/system/tangd.socket.d
      register: systemd_system_tangd_socket

    - name: Create a directory if it does not exist
      file:
        path: /etc/systemd/system/tangd.socket.d
        state: directory
        mode: '0755'
      when: systemd_system_tangd_socket.stat.exists

    - name: Creates the file with the tangd listen port entry
      blockinfile:
        path: /etc/systemd/system/tangd.socket.d/override.conf
        block: |
          [Socket]
          ListenStream=
          ListenStream={{ nbde_server_port }}
        state: present
        create: yes
        mode: '0644'
        marker: "# {mark} ANSIBLE MANAGED BLOCK NBDE"
      register: __nbde_server_daemon_reload

    - name: Reload the daemons so the new changes take effect
      systemd:
        daemon_reload: yes
      when: __nbde_server_daemon_reload is changed  # no-qe no-handler

- name: Ensure the desired port is added to firewalld
  import_role:
    name: fedora.linux-system-roles.firewall
  vars:
    firewall:
      - port: "{{ nbde_server_port }}/tcp"
        zone: "{{ nbde_server_firewall_zone }}"
        state: enabled
        immediate: yes
        permanent: yes

