---
- name: Ensure tang is installed
  package:
    name: "{{ __nbde_server_packages }}"
    state: present


- name: Ensure keys are rotated
  when: nbde_server_rotate_keys
  nbde_server_tang:
    state: keys-rotated
    keygen: "{{ __nbde_server_keygen }}"
    keydir: "{{ __nbde_server_keydir }}"
  notify: nbde_server tang cache update


- name: Ensure we have keys
  when: not nbde_server_rotate_keys
  nbde_server_tang:
    state: keys-created
    keygen: "{{ __nbde_server_keygen }}"
    keydir: "{{ __nbde_server_keydir }}"
  notify: nbde_server tang cache update


- name: Perform key management (fetch/deploy) tasks
  when: nbde_server_fetch_keys or nbde_server_deploy_keys
  include: tang-key-management.yml
  notify: nbde_server tang cache update


- name: Ensure tang is enabled and started
  when: state is not defined or state != "stopped"
  service:
    name: "{{ __nbde_server_service }}"
    enabled: yes
    state: started
  notify: nbde_server tang cache update


- name: Ensure tang is enabled but stopped
  when: state is defined and state == "stopped"
  service:
    name: "{{ __nbde_server_service }}"
    enabled: yes
    state: stopped

- name: Run notified handlers for nbde_server
  meta: flush_handlers

## vim:set ts=2 sw=2 et:
