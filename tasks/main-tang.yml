---
- name: Ensure tang is installed
  package:
    name: "{{ __nbde_server_packages }}"
    state: present


- name: Ensure keys are rotated
  when: nbde_server_rotate_keys
  nbde_server_tang:
    state: keys-rotated
    keygen: "{{ __nbde_server_keygen }}"
    keydir: "{{ __nbde_server_keydir }}"
  notify: nbde_server tang cache update


- name: Ensure we have keys
  when: not nbde_server_rotate_keys
  nbde_server_tang:
    state: keys-created
    keygen: "{{ __nbde_server_keygen }}"
    keydir: "{{ __nbde_server_keydir }}"
  notify: nbde_server tang cache update


- name: Perform key management (fetch/deploy) tasks
  when: nbde_server_fetch_keys or nbde_server_deploy_keys
  include: tang-key-management.yml
  notify: nbde_server tang cache update

- name: Ensure required services are enabled and started
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop: "{{ __nbde_server_services }}"
  notify: nbde_server tang cache update

## vim:set ts=2 sw=2 et:
